{% extends 'accidents/base.html' %}

{% block title %}B·∫£n ƒë·ªì tai n·∫°n{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h4 class="mb-0">üó∫Ô∏è B·∫£n ƒë·ªì ƒëi·ªÉm tai n·∫°n - C·∫ßn Th∆°</h4>
            </div>
            <div class="card-body">
                <button id="locate-btn" class="btn btn-primary mb-3"> V·ªã tr√≠ hi·ªán t·∫°i</button>
                <button id="fullscreen-btn" class="btn btn-info mb-3"> To√†n m√†n h√¨nh</button>
                <div id="map" style="height: 500px;"></div>
                <div class="mt-3">
                    <h5>Ch√∫ th√≠ch m√†u n·ªÅn marker theo lo·∫°i tai n·∫°n:</h5>
                    <div class="row">
                        <div class="col-md-2">
                            <span style="color: red;">‚óè</span> Xe m√°y
                        </div>
                        <div class="col-md-2">
                            <span style="color: blue;">‚óè</span> √î t√¥
                        </div>
                        <div class="col-md-2">
                            <span style="color: orange;">‚óè</span> Xe t·∫£i
                        </div>
                        <div class="col-md-2">
                            <span style="color: purple;">‚óè</span> Ng∆∞·ªùi ƒëi b·ªô
                        </div>
                        <div class="col-md-2">
                            <span style="color: gray;">‚óè</span> Kh√°c
                        </div>
                    </div>
                    <h5 class="mt-3">Ch√∫ th√≠ch vi·ªÅn marker theo m·ª©c ƒë·ªô thi·ªát h·∫°i:</h5>
                    <div class="row">
                        <div class="col-md-3">
                            <span style="border: 2px solid green; color: green; background: white; display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 5px;"></span> Nh·∫π
                        </div>
                        <div class="col-md-3">
                            <span style="border: 2px solid orange; color: orange; background: white; display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 5px;"></span> Trung b√¨nh
                        </div>
                        <div class="col-md-3">
                            <span style="border: 2px solid red; color: red; background: white; display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 5px;"></span> N·∫∑ng
                        </div>
                        <div class="col-md-3">
                            <span style="border: 2px solid black; color: black; background: white; display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 5px;"></span> R·∫•t n·∫∑ng
                        </div>
                    </div>
                    <div class="alert alert-info mt-3">
                        <strong>üí° M·∫πo:</strong> Click v√†o b·∫£n ƒë·ªì ƒë·ªÉ ch·ªçn v·ªã tr√≠ tai n·∫°n m·ªõi. T·ªça ƒë·ªô s·∫Ω ƒë∆∞·ª£c l∆∞u t·∫°m th·ªùi v√† t·ª± ƒë·ªông ƒëi·ªÅn v√†o form "Nh·∫≠p tai n·∫°n" khi b·∫°n chuy·ªÉn trang. ƒê√≥ng popup (d·∫•u X) ƒë·ªÉ h·ªßy l·ª±a ch·ªçn.
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const accidents = {{ accidents_json|safe }};
    
    // Kh·ªüi t·∫°o b·∫£n ƒë·ªì - Trung t√¢m C·∫ßn Th∆°
    const map = L.map('map').setView([10.0452, 105.7469], 12);
    
    // ƒê·ªãnh nghƒ©a c√°c tile layers kh√°c nhau
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    });
    
    const esriSatellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
    });
    
    // Th√™m layer m·∫∑c ƒë·ªãnh
    osm.addTo(map);
    
    // T·∫°o layer control ƒë·ªÉ ƒë·ªïi map
    const baseMaps = {
        "B·∫£n ƒë·ªì ƒë∆∞·ªùng ph·ªë": osm,
        "H√¨nh ·∫£nh v·ªá tinh": esriSatellite
    };
    
    L.control.layers(baseMaps).addTo(map);
    
    // M√†u s·∫Øc n·ªÅn marker theo lo·∫°i tai n·∫°n (t·ªëi ∆∞u: th√™m ƒë·ªô trong su·ªët nh·∫π cho d·ªÖ nh√¨n h∆°n)
    const typeColors = {
        'xe_may': 'rgba(255, 0, 0, 0.8)',  // ƒê·ªè v·ªõi alpha
        'o_to': 'rgba(0, 0, 255, 0.8)',    // Xanh d∆∞∆°ng v·ªõi alpha
        'xe_tai': 'rgba(255, 165, 0, 0.8)', // Cam v·ªõi alpha
        'nguoi_di_bo': 'rgba(128, 0, 128, 0.8)', // T√≠m v·ªõi alpha
        'khac': 'rgba(128, 128, 128, 0.8)' // X√°m v·ªõi alpha
    };
    
    // M√†u s·∫Øc vi·ªÅn marker theo m·ª©c ƒë·ªô thi·ªát h·∫°i (t·ªëi ∆∞u: tƒÉng ƒë·ªô d√†y vi·ªÅn v√† th√™m shadow cho n·ªïi b·∫≠t)
    const damageColors = {
        'nh·∫π': '#28a745',      // Xanh l√° (Bootstrap green)
        'trung b√¨nh': '#fd7e14', // Cam (Bootstrap orange)
        'n·∫∑ng': '#dc3545',     // ƒê·ªè (Bootstrap red)
        'r·∫•t n·∫∑ng': '#000000'  // ƒêen
    };
    
    // T·∫°o custom icon v·ªõi n·ªÅn, vi·ªÅn v√† shadow (t·ªëi ∆∞u: tƒÉng k√≠ch th∆∞·ªõc nh·∫π, th√™m box-shadow cho hi·ªáu ·ª©ng n·ªïi)
    function createIcon(bgColor, borderColor) {
        return L.divIcon({
            className: 'custom-marker',
            html: `<div style="background-color: ${bgColor}; border: 3px solid ${borderColor}; width: 24px; height: 24px; border-radius: 50%; box-shadow: 0 2px 6px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center;"></div>`,
            iconSize: [24, 24],
            iconAnchor: [12, 12]  // CƒÉn gi·ªØa icon
        });
    }
    
    // Th√™m markers
    accidents.forEach(accident => {
        const bgColor = typeColors[accident.type] || 'rgba(128, 128, 128, 0.8)';
        // S·ª≠a l·ªói: Normalize damage level to lowercase ƒë·ªÉ kh·ªõp key (d·ªØ li·ªáu c√≥ th·ªÉ l√† "Nh·∫π", "Trung b√¨nh", etc.)
        const normalizedDamage = accident.damage.toLowerCase();
        const borderColor = damageColors[normalizedDamage] || '#000000';
        const icon = createIcon(bgColor, borderColor);
        
        const marker = L.marker([accident.lat, accident.lng], { icon: icon }).addTo(map);
        
        const popupContent = `
            <div style="min-width: 200px;">
                <h6><strong>${accident.location}</strong></h6>
                <p class="mb-1"><strong>Lo·∫°i:</strong> ${accident.type_display}</p>
                <p class="mb-1"><strong>Th·ªùi gian:</strong> ${accident.datetime}</p>
                <p class="mb-1"><strong>M·ª©c ƒë·ªô:</strong> ${accident.damage}</p>
                <p class="mb-0"><strong>Qu·∫≠n/Huy·ªán:</strong> ${accident.district}</p>
            </div>
        `;
        marker.bindPopup(popupContent);
    });

    // Bi·∫øn to√†n c·ª•c ƒë·ªÉ qu·∫£n l√Ω marker t·∫°m th·ªùi
    let tempMarker = null;

    // S·ª± ki·ªán click tr√™n b·∫£n ƒë·ªì ƒë·ªÉ ch·ªçn v·ªã tr√≠ v√† l∆∞u t·ªça ƒë·ªô
    map.on('click', function(e) {
        const lat = e.latlng.lat.toFixed(6);
        const lng = e.latlng.lng.toFixed(6);
        
        // L∆∞u t·ªça ƒë·ªô v√†o sessionStorage ƒë·ªÉ form "Nh·∫≠p tai n·∫°n" c√≥ th·ªÉ ƒë·ªçc
        sessionStorage.setItem('accident_lat', lat);
        sessionStorage.setItem('accident_lng', lng);
        
        // X√≥a marker c≈© n·∫øu c√≥
        if (tempMarker) {
            map.removeLayer(tempMarker);
        }
        
        // Th√™m marker t·∫°m th·ªùi cho v·ªã tr√≠ m·ªõi (t·ªëi ∆∞u: s·ª≠ d·ª•ng m√†u n·ªïi b·∫≠t h∆°n v·ªõi shadow)
        const tempIcon = L.divIcon({
            className: 'custom-marker',
            html: `<div style="background-color: rgba(50, 205, 50, 0.9); border: 3px solid #000; width: 24px; height: 24px; border-radius: 50%; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"></div>`,
            iconSize: [24, 24],
            iconAnchor: [12, 12]
        });
        tempMarker = L.marker([lat, lng], { icon: tempIcon }).addTo(map);
        tempMarker.bindPopup(`
            <div>
                <strong>üìç V·ªã tr√≠ ƒë∆∞·ª£c ch·ªçn</strong><br>
                <small>Lat: ${lat}<br>Lng: ${lng}</small><br>
                <em>ƒê√£ l∆∞u v√†o form Th√™m Tai n·∫°n. ƒê√≥ng popup ƒë·ªÉ h·ªßy.</em>
            </div>
        `).openPopup();
        
        // Th√¥ng b√°o ng·∫Øn g·ªçn
        const toast = document.createElement('div');
        toast.className = 'alert alert-success position-fixed fade show';
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 250px;';
        toast.innerHTML = `
            <strong>‚úÖ ƒê√£ ch·ªçn v·ªã tr√≠!</strong><br>
            T·ªça ƒë·ªô: ${lat}, ${lng}<br>
            Chuy·ªÉn ƒë·∫øn <a href="{% url 'add_accident' %}" class="alert-link">Nh·∫≠p tai n·∫°n</a> ƒë·ªÉ s·ª≠ d·ª•ng. ƒê√≥ng popup ƒë·ªÉ h·ªßy.
            <button type="button" class="btn-close float-end" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(toast);
        
        // T·ª± ƒë·ªông x√≥a toast sau 5 gi√¢y
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 5000);
    });

    // S·ª± ki·ªán ƒë√≥ng popup ƒë·ªÉ h·ªßy l·ª±a ch·ªçn (thay th·∫ø n√∫t x√≥a)
    map.on('popupclose', function(e) {
        if (tempMarker && tempMarker.getPopup() === e.popup) {
            map.removeLayer(tempMarker);
            tempMarker = null;
            sessionStorage.removeItem('accident_lat');
            sessionStorage.removeItem('accident_lng');
            // Kh√¥ng th√¥ng b√°o alert n·ªØa, ch·ªâ ƒë√≥ng l·∫∑ng l·∫Ω
        }
    });

    // N√∫t v·ªã tr√≠ hi·ªán t·∫°i (t·ªëi ∆∞u: th√™m shadow cho marker hi·ªán t·∫°i)
    document.getElementById('locate-btn').addEventListener('click', function() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    map.setView([lat, lng], 15);
                    
                    // Th√™m marker v·ªã tr√≠ hi·ªán t·∫°i (t√πy ch·ªçn)
                    const currentIcon = L.divIcon({
                        className: 'custom-marker',
                        html: `<div style="background-color: rgba(0, 128, 0, 0.9); width: 24px; height: 24px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"></div>`,
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    });
                    const currentMarker = L.marker([lat, lng], { icon: currentIcon }).addTo(map);
                    currentMarker.bindPopup('<strong>V·ªã tr√≠ hi·ªán t·∫°i</strong>').openPopup();
                    
                    // X√≥a marker sau 5 gi√¢y (t√πy ch·ªçn)
                    setTimeout(() => {
                        map.removeLayer(currentMarker);
                    }, 5000);
                },
                function(error) {
                    let errorMsg;
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg = 'Ng∆∞·ªùi d√πng t·ª´ ch·ªëi chia s·∫ª v·ªã tr√≠.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg = 'Th√¥ng tin v·ªã tr√≠ kh√¥ng kh·∫£ d·ª•ng.';
                            break;
                        case error.TIMEOUT:
                            errorMsg = 'Y√™u c·∫ßu v·ªã tr√≠ h·∫øt th·ªùi gian.';
                            break;
                        default:
                            errorMsg = 'L·ªói kh√¥ng x√°c ƒë·ªãnh.';
                            break;
                    }
                    alert('L·ªói khi l·∫•y v·ªã tr√≠: ' + errorMsg);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        } else {
            alert('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã ƒë·ªãa l√Ω.');
        }
    });

    // N√∫t to√†n m√†n h√¨nh
    document.getElementById('fullscreen-btn').addEventListener('click', function() {
        const mapDiv = document.getElementById('map');
        if (!document.fullscreenElement) {
            mapDiv.requestFullscreen().then(() => {
                mapDiv.style.height = '100vh';
                map.invalidateSize();
            }).catch(err => {
                alert('Kh√¥ng th·ªÉ k√≠ch ho·∫°t to√†n m√†n h√¨nh: ' + err.message);
            });
        } else {
            document.exitFullscreen().then(() => {
                mapDiv.style.height = '500px';
                map.invalidateSize();
            });
        }
    });

    // X·ª≠ l√Ω thay ƒë·ªïi fullscreen ƒë·ªÉ c·∫≠p nh·∫≠t k√≠ch th∆∞·ªõc b·∫£n ƒë·ªì
    document.addEventListener('fullscreenchange', function() {
        const mapDiv = document.getElementById('map');
        if (!document.fullscreenElement) {
            mapDiv.style.height = '500px';
        } else {
            mapDiv.style.height = '100vh';
        }
        map.invalidateSize();
    });
</script>
{% endblock %}