{% extends 'accidents/base.html' %}

{% block title %}Nh·∫≠p th√¥ng tin tai n·∫°n{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 offset-md-2">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">üìù Nh·∫≠p th√¥ng tin v·ª• tai n·∫°n</h4>
            </div>
            <div class="card-body">
                <form method="post" id="accident-form">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label for="{{ form.location.id_for_label }}" class="form-label">ƒêi·ªÉm tai n·∫°n</label>
                        {{ form.location }}
                        {% if form.location.errors %}
                            <div class="text-danger">{{ form.location.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.latitude.id_for_label }}" class="form-label">Vƒ© ƒë·ªô</label>
                                {{ form.latitude }}
                                {% if form.latitude.errors %}
                                    <div class="text-danger">{{ form.latitude.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.longitude.id_for_label }}" class="form-label">Kinh ƒë·ªô</label>
                                {{ form.longitude }}
                                {% if form.longitude.errors %}
                                    <div class="text-danger">{{ form.longitude.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.accident_type.id_for_label }}" class="form-label">Lo·∫°i tai n·∫°n</label>
                                {{ form.accident_type }}
                                {% if form.accident_type.errors %}
                                    <div class="text-danger">{{ form.accident_type.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.damage_level.id_for_label }}" class="form-label">M·ª©c ƒë·ªô thi·ªát h·∫°i</label>
                                {{ form.damage_level }}
                                {% if form.damage_level.errors %}
                                    <div class="text-danger">{{ form.damage_level.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.datetime.id_for_label }}" class="form-label">Th·ªùi gian</label>
                                {{ form.datetime }}
                                {% if form.datetime.errors %}
                                    <div class="text-danger">{{ form.datetime.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.district.id_for_label }}" class="form-label">Qu·∫≠n/Huy·ªán</label>
                                {{ form.district }}
                                {% if form.district.errors %}
                                    <div class="text-danger">{{ form.district.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">Th√™m v·ª• tai n·∫°n</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', async function() {
        const lat = sessionStorage.getItem('accident_lat');
        const lng = sessionStorage.getItem('accident_lng');
        if (lat && lng) {
            const latInput = document.getElementById('id_latitude');  // Gi·∫£ s·ª≠ id l√† id_latitude, ƒëi·ªÅu ch·ªânh n·∫øu kh√°c
            const lngInput = document.getElementById('id_longitude');  // Gi·∫£ s·ª≠ id l√† id_longitude, ƒëi·ªÅu ch·ªânh n·∫øu kh√°c
            const locationInput = document.getElementById('id_location');
            const districtInput = document.getElementById('id_district');
            
            if (latInput) latInput.value = lat;
            if (lngInput) lngInput.value = lng;
            
            // Hi·ªÉn th·ªã th√¥ng b√°o t·∫°m th·ªùi
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-info alert-dismissible fade show';
            alertDiv.id = 'geocode-loading';
            alertDiv.innerHTML = `
                ‚è≥ ƒêang t·ª± ƒë·ªông tra c·ª©u ƒë·ªãa ch·ªâ t·ª´ t·ªça ƒë·ªô: Lat ${lat}, Lng ${lng}...
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            const formContainer = document.querySelector('.card-body') || document.body;
            formContainer.insertBefore(alertDiv, formContainer.firstChild);
            
            try {
                // G·ªçi API reverse geocoding t·ª´ Nominatim (OpenStreetMap)
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1&zoom=18`);
                if (!response.ok) {
                    throw new Error('API request failed');
                }
                const data = await response.json();
                
                if (data && data.display_name) {
                    // ƒêi·ªÅn ƒë·ªãa ch·ªâ ƒë·∫ßy ƒë·ªß v√†o location
                    if (locationInput) {
                        locationInput.value = data.display_name;
                    }
                    
                    // Parse qu·∫≠n/huy·ªán cho C·∫ßn Th∆° (city_district ho·∫∑c suburb)
                    let district = '';
                    if (data.address.city_district) {
                        district = data.address.city_district;
                    } else if (data.address.suburb) {
                        district = data.address.suburb;
                    } else if (data.address.neighbourhood) {
                        district = data.address.neighbourhood;
                    } else if (data.address.road) {
                        district = data.address.road;  // Fallback
                    }
                    
                    if (districtInput) {
                        // N·∫øu district l√† select, t√¨m option ph√π h·ª£p ho·∫∑c set value
                        if (districtInput.tagName === 'SELECT') {
                            const option = Array.from(districtInput.options).find(opt => opt.text.toLowerCase().includes(district.toLowerCase()) || opt.value.toLowerCase().includes(district.toLowerCase()));
                            if (option) {
                                districtInput.value = option.value;
                            } else {
                                districtInput.value = district;  // N·∫øu kh√¥ng t√¨m th·∫•y, set text
                            }
                        } else {
                            districtInput.value = district;
                        }
                    }
                    
                    // C·∫≠p nh·∫≠t th√¥ng b√°o th√†nh c√¥ng
                    alertDiv.className = 'alert alert-success alert-dismissible fade show';
                    alertDiv.innerHTML = `
                        ‚úÖ T·ªça ƒë·ªô ƒë√£ ƒë∆∞·ª£c ƒëi·ªÅn v√† ƒë·ªãa ch·ªâ t·ª± ƒë·ªông tra c·ª©u: ${data.display_name.substring(0, 100)}${data.display_name.length > 100 ? '...' : ''}.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                } else {
                    throw new Error('No address found');
                }
            } catch (error) {
                console.error('Reverse geocoding error:', error);
                // C·∫≠p nh·∫≠t th√¥ng b√°o l·ªói
                alertDiv.className = 'alert alert-warning alert-dismissible fade show';
                alertDiv.innerHTML = `
                    ‚ö†Ô∏è T·ªça ƒë·ªô ƒë√£ ƒë∆∞·ª£c ƒëi·ªÅn nh∆∞ng kh√¥ng th·ªÉ tra c·ª©u ƒë·ªãa ch·ªâ t·ª± ƒë·ªông. Vui l√≤ng nh·∫≠p th·ªß c√¥ng.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
            }
            
            // X√≥a sessionStorage sau khi s·ª≠ d·ª•ng
            sessionStorage.removeItem('accident_lat');
            sessionStorage.removeItem('accident_lng');
            
            // T·ª± ƒë·ªông x√≥a alert sau 10 gi√¢y
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 10000);
        }
    });
</script>
{% endblock %}